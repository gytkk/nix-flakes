#!/usr/bin/env bash

# Terraform layout í•¨ìˆ˜
layout_terraform() {
  # Terraform ì„¤ì • íŒŒì¼ë“¤ ë³€ê²½ ê°ì§€
  watch_file backend.tf
  watch_file versions.tf
  watch_file main.tf
  
  # Terraform ë²„ì „ íŒŒì‹± í•¨ìˆ˜ (ë‚´ë¶€)
  local tf_version
  for file in backend.tf versions.tf main.tf; do
    if [[ -f "$file" ]]; then
      tf_version=$(grep -o 'required_version.*=.*"[^"]*"' "$file" | \
                   sed -n 's/.*"\([^"]*\)".*/\1/p' | head -1)
      if [[ -n "$tf_version" ]]; then
        # ì—°ì‚°ì ì œê±°í•˜ê³  ë²„ì „ë§Œ ì¶”ì¶œ
        tf_version=$(echo "$tf_version" | sed -E 's/^[><=~]+ *([0-9.]+).*/\1/')
        break
      fi
    fi
  done
  
  # ê¸°ë³¸ê°’ ì„¤ì •
  tf_version=${tf_version:-"1.12.2"}
  
  # TF_VERSION í™˜ê²½ë³€ìˆ˜ ì„¤ì •
  export TF_VERSION="$tf_version"
  
  # ë²„ì „ì„ shell ì´ë¦„ìœ¼ë¡œ ë³€í™˜ (1.10.5 -> terraform-1-10-5)
  local shell_name="terraform-${tf_version//\./-}"
  
  # íŠ¹ì • ë²„ì „ì˜ devShell ì‚¬ìš©
  use flake ~/.config/nix-direnv/terraform-flake#${shell_name}
  
  log_status "ğŸš€ Terraform $tf_version environment loaded"
}