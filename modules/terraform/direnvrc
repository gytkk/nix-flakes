#!/usr/bin/env bash

# Terraform layout 함수
layout_terraform() {
  # Terraform 설정 파일들 변경 감지
  watch_file backend.tf
  watch_file versions.tf
  watch_file main.tf
  
  # Terraform 버전 파싱 함수 (내부)
  local tf_version
  for file in backend.tf versions.tf main.tf; do
    if [[ -f "$file" ]]; then
      tf_version=$(grep -o 'required_version.*=.*"[^"]*"' "$file" | \
                   sed -n 's/.*"\([^"]*\)".*/\1/p' | head -1)
      if [[ -n "$tf_version" ]]; then
        # 연산자 제거하고 버전만 추출
        tf_version=$(echo "$tf_version" | sed -E 's/^[><=~]+ *([0-9.]+).*/\1/')
        break
      fi
    fi
  done
  
  # 기본값 설정
  tf_version=${tf_version:-"1.12.2"}
  
  # TF_VERSION 환경변수 설정
  export TF_VERSION="$tf_version"
  
  # 버전을 shell 이름으로 변환 (1.10.5 -> terraform-1-10-5)
  local shell_name="terraform-${tf_version//\./-}"
  
  # 특정 버전의 devShell 사용
  use flake ~/.config/nix-direnv/terraform-flake#${shell_name}
  
  log_status "🚀 Terraform $tf_version environment loaded"
}