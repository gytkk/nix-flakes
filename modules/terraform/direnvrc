#!/usr/bin/env bash

# Terraform layout 함수
layout_terraform() {
  # Terraform 설정 파일들 변경 감지
  watch_file backend.tf
  watch_file versions.tf
  watch_file main.tf
  
  # .direnv 디렉토리 생성
  mkdir -p .direnv
  
  # .direnv/flake.nix가 없으면 자동 생성
  if [[ ! -f ".direnv/flake.nix" ]]; then
    log_status "Creating .direnv/flake.nix..."
    
    # Terraform 버전을 미리 파싱
    TERRAFORM_VERSION="@DEFAULT_VERSION@"  # Nix에서 치환됨
    
    # backend.tf, versions.tf, main.tf에서 required_version 찾기
    for file in "backend.tf" "versions.tf" "main.tf"; do
      if [[ -f "$file" ]]; then
        VERSION_SPEC=$(grep -o 'required_version[ ]*=[ ]*"[^"]*"' "$file" | sed 's/.*"\([^"]*\)".*/\1/' | head -1)
        if [[ -n "$VERSION_SPEC" ]]; then
          log_status "Found version spec in $file: $VERSION_SPEC"
          
          # 사용 가능한 버전 목록 (Nix에서 치환됨)
          AVAILABLE_VERSIONS="@AVAILABLE_VERSIONS@"
          
          # ~> 버전 제약사항을 처리하여 사용 가능한 버전 중에서 찾기
          if [[ "$VERSION_SPEC" =~ ~\>[[:space:]]*([0-9]+\.[0-9]+)([\.0-9]*) ]]; then
            MAJOR_MINOR="${BASH_REMATCH[1]}"
            # 해당 major.minor와 일치하는 가장 높은 버전 찾기
            for version in $AVAILABLE_VERSIONS; do
              if [[ "$version" =~ ^$MAJOR_MINOR\.[0-9]+$ ]]; then
                TERRAFORM_VERSION="$version"
              fi
            done
          elif [[ "$VERSION_SPEC" =~ =[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            TERRAFORM_VERSION="${BASH_REMATCH[1]}"
          elif [[ "$VERSION_SPEC" =~ \>=[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            TERRAFORM_VERSION="${BASH_REMATCH[1]}"
          fi
          break
        fi
      fi
    done
    
    log_status "Using Terraform version: $TERRAFORM_VERSION"
    
    cat > .direnv/flake.nix << FLAKE_EOF
{
  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixpkgs-unstable";
    nixpkgs-terraform.url = "github:stackbuilders/nixpkgs-terraform";
  };

  outputs = { self, nixpkgs, nixpkgs-terraform }:
    let
      systems = [ "x86_64-linux" "aarch64-darwin" "aarch64-linux" "x86_64-darwin" ];
      forAllSystems = nixpkgs.lib.genAttrs systems;
    in
    {
      devShells = forAllSystems (system:
        let
          pkgs = nixpkgs.legacyPackages.\${system};
          terraform = nixpkgs-terraform.packages.\${system}."$TERRAFORM_VERSION";
        in
        {
          default = pkgs.mkShell {
            buildInputs = [ terraform ];
          };
        });
    };
}
FLAKE_EOF
  fi
  
  # .direnv 디렉토리의 flake 사용 (절대 경로로)
  use flake "path:$(pwd)/.direnv" --impure
}
